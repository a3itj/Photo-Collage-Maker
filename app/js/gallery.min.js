$(function(){"use strict";function a(a){var b=parseInt(a);return null==b||isNaN(b)?0:b}function b(a){function b(a){a.preventDefault(),a.stopPropagation(),g(a),$(document).on("mousemove",d),$(document).on("mouseup",c)}function c(a){a.preventDefault(),$(document).off("mouseup",c),$(document).off("mousemove",d)}function d(a){var b,c,d,f,g,i,l=(h.offset(),a.clientX+$(window).scrollLeft()),n=a.clientY+$(window).scrollTop(),o=$(m.evnt.target),p=m.angle,q=o.attr("action");if(q)switch(q){case"se":b=l-m.left,c=n-m.top,d=m.left,f=m.top;break;case"sw":b=m.width-(l-m.left),c=n-m.top,d=l,f=m.top;break;case"s":b=m.width,c=n-m.top,d=m.left,f=m.top;break;case"nw":b=m.width-(l-m.left),c=m.height-(n-m.top),d=l,f=n;break;case"w":b=m.width-(l-m.left),c=m.height,d=l,f=m.top;break;case"ne":b=l-m.left,c=m.height-(n-m.top),d=m.left,f=n;break;case"e":b=l-m.left,c=m.height,d=m.left,f=m.top;break;case"r":b=m.width,c=m.height,g=parseInt(l-j)-m.width,i=parseInt(n-k)-m.height,p=Math.round(Math.atan2(i,g)*(180/Math.PI))}var r=_.throttle(function(a){e(b,c,p),h.offset({left:d,top:f})},250);r()}function e(a,b,c){var d=c||0;n.width=a,n.height=b;var e=n.getContext("2d");e.drawImage(i,0,0,a,b),$(l).attr("src",n.toDataURL("image/png")),$(l).closest(".resize-container").css({"-webkit-transform":"rotate("+10*d+"deg)",transform:"rotate("+d+"deg)"})}function f(a){var b=a.css("-webkit-transform")||a.css("-moz-transform")||a.css("-ms-transform")||a.css("-o-transform")||a.css("transform");if("none"!==b)var c=b.split("(")[1].split(")")[0].split(","),d=c[0],e=c[1],f=Math.round(Math.atan2(e,d)*(180/Math.PI));else var f=0;return 0>f?f+360:f}function g(a){m.width=h.width(),m.height=h.height(),m.left=h.offset().left,m.top=h.offset().top,m.mouse_x=(a.clientX||a.pageX||a.originalEvent.touches[0].clientX)+$(window).scrollLeft(),m.mouse_y=(a.clientY||a.pageY||a.originalEvent.touches[0].clientY)+$(window).scrollTop(),m.evnt=a,m.angle=f(h)}var h=$(a),i=new Image,l=h.find("img")[0],m={},n=document.createElement("canvas");i.src=$(l).attr("src"),h.on("mousedown",".resize",b)}function c(a){a.preventDefault();var b=a.originalEvent.dataTransfer,c=b?b.files:a.target.files;_.forEach(c,function(a){var b=new FileReader;b.readAsDataURL(a);var c=$(b);c.on("loadend",function(a,b){var c=this.result,d=$("<img/>");d.attr("id","img-"+g++),d.attr("file",b),d.attr("src",c),d.attr("draggable",!0),e.append(d)})}),a.stopPropagation()}if(window.FileReader){var d=$("#dropFile"),e=$("#thumbNails"),f=$("#workspace"),g=0,h=0,i=0,j=0,k=0,l=null,m=$(document),n=$("#fileUpload");d.click(function(){n.trigger("click")}),n.on("change",c),d.on("dragover",function(a){a.preventDefault()}),d.on("dragenter",function(a){a.preventDefault()}),d.on("drop",c),e.on("dragstart",function(a){var b=a.target.nodeName;"IMG"==b&&a.originalEvent.dataTransfer.setData("text",$(a.target).attr("id"))}),m.keydown(function(a){(46===a.keyCode||8===a.keyCode)&&$(".selected").remove()}),f.on("dragover",function(a){a.preventDefault()}),f.on("dragenter",function(a){a.preventDefault()}),f.on("drop",function(a){a.preventDefault();var b=a.originalEvent.dataTransfer.getData("text"),c=$("#"+b),d=c.clone();d.attr(b,"cloned-"+b),f.append(d),$(d).wrap('<div class="resize-container drag pos-abs" id="resizeContainer-'+b+'"></div>').before('<span class="resize rotate" action="r"></span>').before('<span class="resize resize-nw" action="nw"></span>').before('<span class="resize resize-w" action="w"></span>').before('<span class="resize resize-ne" action="ne"></span>').before('<span class="resize resize-e" action="e"></span>').after('<span class="resize resize-se" action="se"></span>').after('<span class="resize resize-sw" action="sw"></span>').after('<span class="resize resize-s" action="s"></span>')}),f.on("dragstart",function(b){var c=$(b.target).closest(".drag");c.length&&(l=c,h=b.originalEvent.clientX,i=b.originalEvent.clientY,j=a(l.css("left")),k=a(l.css("top")),b.originalEvent.dataTransfer.setData("text/plain",+(j-h)+","+ +(k-i)))}),f.on("dragover",function(a){return a.preventDefault(),!1}),f.click(function(a){f.find(".resize-container.selected").removeClass("selected");var c=$(a.target).closest(".resize-container");c.length&&(c.addClass("selected"),b(c[0]))}),f.on("drop",function(a){var b=a.originalEvent.dataTransfer.getData("text/plain").split(","),c=l;if(c){var d=a.originalEvent.clientX+parseInt(b[0],10)+"px",e=a.originalEvent.clientY+parseInt(b[1],10)+"px";return c.css({left:d,top:e}),a.preventDefault(),!1}})}else alert("your browser does not support file reader API")});